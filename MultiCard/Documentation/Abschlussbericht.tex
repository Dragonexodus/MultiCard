\input{Header}
%TODO						
\title{Abschlussbericht für das Modul SmartCard-Programmeriung}
\subtitle{Implementierung einer Mulitcard-Anwendung\vspace{1cm}}

%TODO
\author{}
\date{\today}
\begin{document}
\maketitle

\tableofcontents
\pagebreak

\section{Einleitung}
todo

\paragraph{Aufgabe:}
todo

\paragraph{Verlauf:}
todo

\paragraph{Ergebnis:}
todo

\paragraph{Aufbau:}
todo
%TODO Aufgabenverteilung
%TODO SIMULATIOn

\section{OnCard}
\subsection{Student-Applet}
todo
\subsection{Disco-Applet}
todo
\subsection{Crypto-Applet}
%TODO
Der komplette Datenaustausch zwischen SmartCard und OffCard-Anwendung soll verschlüsselt und signiert geschehen. 
Damit nicht jedes Applet die dafür notwendige Logik implementieren muss, wurde mit dem Crypto-Applet eine zentrale Anlaufstelle für folgende Aufgaben geschaffen:

verschlüsseln und signieren

entschlüsseln und verifizieren

Als Kryptosystem wird RSA mit einer Schlüssellänge von 512 Bit eingesetzt. Ursprünglich war eine Schlüssellänge von 1024 Bit angedacht, jedoch resultierte daraus ein Ciphertext von 128 Byte. Zusammen mit der Signatur entstehen somit 256 Byte an zu versendenden Daten. Da die vorliegenden Smart-
Cards jedoch nur 255 Byte an Daten unterstützen, wurde sich für eine Reduzierung der Schlüssellänge entschieden.
Das Cryptography-Applet stellt folgende öffentlich zugängliche Anweisungen bereit:

%INS_IMPORT_CARD_PRIVATE_MOD 0xF0
%INS_IMPORT_CARD_PRIVATE_EXP 0xF1
%INS_IMPORT_CARD_PUBLIC_MOD 0xF2
%INS_IMPORT_CARD_PUBLIC_EXP 0xF3
%INS_EXPORT_CARD_PUBLIC_MOD 0xF4
%INS_EXPORT_CARD_PUBLIC_EXP 0xF5
%INS_IMPORT_TERMINAL_PUBLIC_MOD 0xE0
%INS_IMPORT_TERMINAL_PUBLIC_EXP 0xE1

Wie an den Anweisungsnamen erkennbar ist, ist es möglich, das Schlüsselpaar bestehend aus privaten und öffentlichen Schlüssel für die Karte zu importieren. Dies ist notwendig, da sonst die Signierung nicht als Sicher eingestuft werden kann.
Nach der Installation der Applets befindet sich die Karte in ihrem Werkszustand. Es sind keine Schlüsselpaare und auch keine Daten auf der Karte gesetzt. 
Um die Karte benutzen zu können, müssen nun
als erstes die Schlüssel für das RSA Kryptosystem gesetzt werden. 
Dazu wird die OffCard-Anwendung genutzt. 
Eine nachträgliche Änderung der Schlüssel wird mit Hilfe von Flags unterbunden. Die Karte ist somit gebrandmarkt.
Im gesamten Hotel existiert ein Schlüsselpaar für die Karten und ein Schlüsselpaar für die Terminals.
Auch wenn eine dritte Partei eine Karte im Werkszustand in die Hand bekommen und seine eigenen Schlüssel setzen sollte bleibt das System sicher. Es ist nicht möglich, an die Karte gesendete Daten zu entschlüsseln, da der private Schlüssel der Karte falsch ist sowie die Signatur nicht mit dem privaten
Schlüssel der Terminals verifiziert werden kann. 
Aufgrund der nicht passenden Schlüssel ist es ebenso wenig möglich, gefälschte Daten an die OffCard-Anwendung zu schicken. Das System wird erst unsicher, wenn die Schlüsselpaare für Karten und Terminals bekannt würden. Mit ihnen ist es dann möglich vertrauenswürdige Karten zu fälschen.
Die Methoden für die Ver- und Entschlüsselung sind innerhalb der Karte über die Applet-Firewall zugänglich. Den Applets Student und Disco ist es erlaubt, eine Instanz des Crypto-Applets zu erhalten. 
Je nach Richtung der Datenübertragung können diese Applets dann entweder Daten ver- oder entschlüsseln. 
%Bei ein- und ausgehenden verschlüsselten Daten hat die APDU folgenden Aufbau:
%CLA
%INS
%P1
%P2
%LC (0x80)
%64 Byte verschlüsselte Daten
%64 Byte Signatur
%LE

Beim Aufruf der Entschlüsselungs-Methode (decrypt) werden die 64 Bit Daten mit dem privaten Schlüssel der Karte entschlüsselt. 
Der dadurch gewonnene Klartext wird mithilfe des öffentlichen Schlüssels des Terminals und der mitgesendeten Signatur verifiziert. 
Der Klartext wird für die weitere Verwendung im Puffer abgelegt. 
%Schlägt die Verifizierung fehl, wird die ISO-ExceptionISO7816.SW_DATA_INVALID ausgelöst. 
In diesem Fall ist davon auszugehen, dass die Daten manipuliert wurden.
Beim Aufruf der Verschlüsslungs-Methode (encrypt) werden die in die Methode übergebenen Daten mit dem privaten Schlüssel der Karte signiert. 
Weiterhin werden die Daten mit dem öffentlichen Schlüssel des Terminals verschlüsselt. 
Daten und Signatur werden im Puffer abgelegt und können vom aufrufenden Applet versendet werden.
Im Gegensatz zu allen anderen Applets ist für das Crypto-Applet keine Reset Möglichkeit vorgesehen. Um die Schlüssel neu setzen zu können, muss das Applet neu installiert werden.

\section{OffCard}
%TODO MINDESTAFORDERUNGEN Java 8,60
%TODO AUFBAU,Bilder
\subsection{Simulation}
%TODO
Für die Benutzung der OffCard-Anwendung mit der simulierten SmartCard muss in der opencard.properties Datei die Konfiguration für die Simulation aktiv sein.
Die Konfiguration für die reale SmartCard muss mit Zeilenkommentaren (\#) deaktiviert werden.
Die Simulation der SmartCard muss im Eclipse gestartet werden.
Anschließend muss das Terminal mit dem Port 8050 geöffnet werden. 
Dazu kann folgender Befehl verwendet werden:
/terminal "Remote|localhost:8050"
Nach dem Freigeben der Verbindung mit /close kann die OffCard-Anwendung gestartet und benutzt werden.

\subsection{Connection-Tab}
todo
\subsection{Configuration-Tab}
todo
\subsection{Student-Tab}
todo
\subsection{Disco-Tab}

\section{Fazit}
todo
\end{document}